# –ê–Ω–∞–ª–∏–∑ –¢–ó –∏ –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –ì—Ä—É–ø–ø–æ–≤—ã–µ –ø–æ–¥–∑–µ–º–µ–ª—å—è (GD)

*–í–µ—Ä—Å–∏—è 1.0 ‚Äî –∞–Ω–∞–ª–∏–∑ –¢–ó v2.0, –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏*

---

## –ß–∞—Å—Ç—å I. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¢–ó

### 1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–∫—É—â–µ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

| –ê—Å–ø–µ–∫—Ç –¢–ó | –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –í—ã–≤–æ–¥ |
|-----------|------------------|--------|
| **–¢–∏–ø –ø–æ–¥–∑–µ–º–µ–ª—å—è GROUP** | –í `DungeonType` —É–∂–µ –µ—Å—Ç—å `GROUP = 3` | –ì–æ—Ç–æ–≤–æ |
| **–ú–æ–¥–µ–ª–∏ –ø–æ–¥–∑–µ–º–µ–ª–∏–π** | `Dungeon`, `Monster`, `DungeonProgress`, `DungeonRun` ‚Äî –≤—Å—ë **per-player** | GD —Ç—Ä–µ–±—É–µ—Ç **per-chat** —Å—É—â–Ω–æ—Å—Ç–∏: —Å–µ—Å—Å–∏—è –Ω–∞ —á–∞—Ç, –æ–±—â–∏–π HP –º–æ–Ω—Å—Ç—Ä–∞ |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ** | `bot_handlers.group_message_damage` ‚Üí `combat_service.process_message_damage`; –ø—Ä–∏–≤—è–∑–∫–∞ –∫ **player_id** –∏ –∞–∫—Ç–∏–≤–Ω–æ–º—É **run/progress** –∏–≥—Ä–æ–∫–∞ | –î–ª—è GD –Ω—É–∂–Ω–∞ –≤–µ—Ç–∫–∞: –ø–æ **chat_id** –∏—Å–∫–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é **gd_session**, —Å—á–∏—Ç–∞—Ç—å —É—Ä–æ–Ω –ø–æ —Ñ–æ—Ä–º—É–ª–µ GD –∏ —Å–ø–∏—Å—ã–≤–∞—Ç—å —Å –æ–±—â–µ–≥–æ HP |
| **–£—Ä–æ–Ω** | `calculate_message_damage` (media, length, stats, weapon) | –§–æ—Ä–º—É–ª–∞ GD –¥—Ä—É–≥–∞—è: `—É—Ä–æ–Ω_–≤–∞–π—Ñ—É √ó –∫—Ä–µ–∞—Ç–∏–≤ √ó —Å–æ–±—ã—Ç–∏–µ √ó –∞–¥–∞–ø—Ç–∞—Ü–∏—è`; ¬´—É—Ä–æ–Ω_–≤–∞–π—Ñ—É¬ª –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã (effective damage), –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –Ω–æ–≤—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ |
| **–ö–ª–∞—Å—Å—ã –≤–∞–π—Ñ—É** | `WaifuClass`: KNIGHT, WARRIOR (—Ç–∞–Ω–∫–∏), ARCHER, MAGE, ASSASSIN (DPS), HEALER, MERCHANT (–ø–æ–¥–¥–µ—Ä–∂–∫–∞) | –¢–ó: —Ç–∞–Ω–∫–∏ = –†—ã—Ü–∞—Ä—å/–í–æ–∏–Ω, –ª–µ–∫–∞—Ä–∏ = –æ—Ç–¥–µ–ª—å–Ω–æ, ¬´–≤—Å–µ –∫–ª–∞—Å—Å—ã¬ª ‚Äî –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ —ç—Ç–∏ enum'—ã |
| **–ë–∞–∑–∞ –ø–æ–¥–∑–µ–º–µ–ª–∏–π** | –ï—Å—Ç—å –ø—É–ª—ã –∏ —à–∞–±–ª–æ–Ω—ã –º–æ–Ω—Å—Ç—Ä–æ–≤ (DungeonPool, MonsterTemplate), —Å–æ–ª—å–Ω—ã–µ –ø–æ–¥–∑–µ–º–µ–ª—å—è –ø–æ act/dungeon_number | 5 —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö GD ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É–ª –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (gd_dungeon_templates) —Å –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º –•–ü –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å–æ–±—ã—Ç–∏–µ–º |
| **–ß–∞—Ç / –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** | –ù–µ—Ç —Å—É—â–Ω–æ—Å—Ç–µ–π ¬´—á–∞—Ç¬ª, ¬´–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á–∞—Ç–∞¬ª, ¬´–∏–≥—Ä–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞ –ø–µ—Ä–∏–æ–¥¬ª | –ù—É–∂–Ω—ã: —Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∫—ç—à –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–∞—Ç–∞ –∏ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ `/gd_start` –∏ –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ |
| **–í–∫–ª–∞–¥–∫–∞ ¬´–ì—Ä—É–ø–ø–æ–≤—ã–µ¬ª** | –í `dungeons.html` –µ—Å—Ç—å —Ç–∞–± ¬´–ì—Ä—É–ø–ø–æ–≤—ã–µ¬ª, –∫–æ–Ω—Ç–µ–Ω—Ç: ¬´—Å–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã¬ª | –ù—É–∂–µ–Ω –∫–æ–Ω—Ç–µ–Ω—Ç: —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ GD (–µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤ —á–∞—Ç–µ —Å –∞–∫—Ç–∏–≤–Ω—ã–º), –∏—Å—Ç–æ—Ä–∏—è, —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –≤ Telegram: `/gd_start`) |

**–ò—Ç–æ–≥:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è GD ‚Äî —ç—Ç–æ **–Ω–æ–≤—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ä–µ–∑**: –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–µ—Å—Å–∏–π/–≤–∫–ª–∞–¥–æ–≤, –æ—Ç–¥–µ–ª—å–Ω–∞—è –≤–µ—Ç–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–º–∞–Ω–¥, –æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –∏ –Ω–∞–≥—Ä–∞–¥. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è: –º–æ–¥–µ–ª—å –≤–∞–π—Ñ—É (–∫–ª–∞—Å—Å, —Å—Ç–∞—Ç—ã, —É—Ä–æ–Ω), –æ–±—â–∞—è –∏–¥–µ—è ¬´—Å–æ–æ–±—â–µ–Ω–∏–µ ‚Üí —É—Ä–æ–Ω¬ª, Telegram-–±–æ—Ç –∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è).

---

### 2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Ä–∏—Å–∫–∏

#### 2.1. –£—á—ë—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–∞—Ç–∞ –∏ –∏–≥—Ä–æ–∫–æ–≤

- **–¢–ó:** ¬´‚â•3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞ –∑–∞ 24—á¬ª, ¬´‚â•4 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 –º–∏–Ω¬ª, ¬´‚â•3 –¥–Ω—è –≤ —á–∞—Ç–µ¬ª, ¬´‚â•2 –∏–≥—Ä–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è –∑–∞ 7 –¥–Ω–µ–π¬ª.
- **–†–∏—Å–∫:** –ù–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü ¬´—Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ¬ª –∏ ¬´–∏–≥—Ä–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ¬ª. –•—Ä–∞–Ω–∏—Ç—å –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î ‚Äî –Ω–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—ä—ë–º.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
  - **–ò–≥—Ä–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ:** —Å—á–∏—Ç–∞—Ç—å —è–≤–Ω–æ: —É—Ä–æ–Ω –≤ GD/—Å–æ–ª—å–Ω–æ–º –¥–∞–Ω–∂–µ, —É—á–∞—Å—Ç–∏–µ –≤ —Å–æ–±—ã—Ç–∏–∏ GD, –≤—ã–∑–æ–≤ –∫–æ–º–∞–Ω–¥ –±–æ—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä `/gd_start`, `/engage`). –ü–∏—à–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `player_game_actions` (player_id, chat_id, action_type, created_at) —Å TTL –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π.
  - **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á–∞—Ç–∞ (—Å–æ–æ–±—â–µ–Ω–∏—è/–º–∏–Ω):** –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Redis**: –∫–ª—é—á –ø–æ chat_id, sliding window –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –º–∏–Ω—É—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä 60), —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π; –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ –≥—Ä—É–ø–ø–µ ‚Äî INCR + –∑–∞–ø–∏—Å—å –≤—Ä–µ–º–µ–Ω–∏ –≤ sorted set, –∑–∞—Ç–µ–º –ø–æ–¥—Å—á—ë—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 –º–∏–Ω. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —Å—á—ë—Ç—á–∏–∫ –≤ Redis —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º –∑–∞ 60 –º–∏–Ω –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–∏ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ —á–∞—Ç–µ (–º–µ–Ω–µ–µ —Ç–æ—á–Ω–æ, –Ω–æ –ø—Ä–æ—â–µ).
  - **¬´3 –¥–Ω—è –≤ —á–∞—Ç–µ¬ª:** –ø–µ—Ä–≤–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ player_id –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —á–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–µ –∏–≥—Ä–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —É—á—Ç—ë–Ω–Ω–æ–µ –±–æ—Ç–æ–º). –•—Ä–∞–Ω–∏—Ç—å –≤ –ë–î: `player_chat_first_seen(player_id, chat_id, first_seen_at)`.

#### 2.2. –†–µ–π—Ç-–ª–∏–º–∏—Ç—ã –∏ –æ—Ç–≤–µ—Ç ¬´—á–µ—Ä–µ–∑ 10+ —Å–µ–∫—É–Ω–¥¬ª

- **–¢–ó:** –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø–æ–¥–∑–µ–º–µ–ª—å–µ –Ω–∞ `/gd_start` –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π (—Ä–µ–π—Ç-–ª–∏–º–∏—Ç), —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–ü–æ–¥–∑–µ–º–µ–ª—å–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ!¬ª.
- **–†–∏—Å–∫:** –í aiogram –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –æ—Ç–≤–µ—Ç–∞; –µ—Å–ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –ø–æ –¢–ó —ç—Ç–æ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ ¬´–ø–æ–¥–∑–µ–º–µ–ª—å–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ¬ª –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞ –¥–µ–ª–∞—Ç—å `await asyncio.sleep(10)` (–∏–ª–∏ —Å–ª—É—á–∞–π 10‚Äì15 —Å–µ–∫), –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –†–µ–π—Ç-–ª–∏–º–∏—Ç –Ω–∞ —Å–∞–º—É –∫–æ–º–∞–Ω–¥—É `/gd_start`: 1 —Ä–∞–∑ –≤ 2 —á–∞—Å–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Ö—Ä–∞–Ω–∏—Ç—å –≤ Redis (–∫–ª—é—á `gd_start_cooldown:{user_id}`, TTL 2 —á–∞—Å–∞).

#### 2.3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫

- **–¢–ó:** –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–µ—Å—Å–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫.
- **–†–∏—Å–∫:** –ï—Å–ª–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ –≤–µ–±—Ö—É–∫—É (—Å–æ–æ–±—â–µ–Ω–∏—è), ¬´—Ç–∏–∫–∏¬ª —Ä–∞–∑ –≤ 30 —Å–µ–∫ –Ω—É–∂–µ–Ω —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (asyncio loop –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π worker): —Ä–∞–∑ –≤ 30 —Å–µ–∫ –æ–±—Ö–æ–¥–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ `gd_sessions` –∏ –≤—ã–∑—ã–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (current_monster_hp, current_stage, last_activity_at, adaptive_regressions_count –∏ —Ç.–¥.). –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–±—ã—Ç–∏–∏ (—É—Ä–æ–Ω, —Ä–µ–≥—Ä–µ—Å—Å–∏—è, —Å–º–µ–Ω–∞ —ç—Ç–∞–ø–∞) + —Ç–∞–π–º–µ—Ä ¬´–Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 30 —Å–µ–∫¬ª –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏.

#### 2.4. –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è –•–ü –∏ ¬´–¥–æ 90 –º–∏–Ω—É—Ç¬ª

- **–¢–ó:** –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ <2 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 90 —Å–µ–∫ ‚Äî —Å–Ω—è—Ç—å 1.2% –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –•–ü –º–æ–Ω—Å—Ç—Ä–∞ –∫–∞–∂–¥—ã–µ 90 —Å–µ–∫; –ø—Ä–∏ 75+ –º–∏–Ω –∏ –•–ü >5% ‚Äî —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–±–µ–¥—É.
- **–†–∏—Å–∫:** –†–µ–≥—Ä–µ—Å—Å–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∫—É ¬´75 –º–∏–Ω¬ª –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏; —Ç–µ –∂–µ 90 —Å–µ–∫ ‚Äî –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í —Ç–æ–º –∂–µ —Ñ–æ–Ω–æ–≤–æ–º —Ü–∏–∫–ª–µ, —á—Ç–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –¥–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `last_activity_at` –∏ —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 —Å–µ–∫ (Redis –∏–ª–∏ –ø–æ –ª–æ–≥–∞–º/—Ç–∞–±–ª–∏—Ü–µ). –ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–≥—Ä–µ—Å—Å–∏—é –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é. –û—Ç–¥–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å `duration_minutes > 75` –∏ `current_monster_hp > base_hp * 0.05` ‚Üí –æ–±–Ω—É–ª–∏—Ç—å HP –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç–∞–ø/–ø–æ–¥–∑–µ–º–µ–ª—å–µ.

#### 2.5. –°–æ–±—ã—Ç–∏—è: —Ç—Ä–∏–≥–≥–µ—Ä—ã 50% / 10% HP

- **–¢–ó:** –û–¥–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ; –ø—Ä–∏ 50% –∏ 10% HP ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è (–ø–æ —Ä–∞–∑—É –∑–∞ –º–æ–Ω—Å—Ç—Ä–∞).
- **–†–∏—Å–∫:** –ï—Å–ª–∏ —É—Ä–æ–Ω –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–∞—á–∫–æ–π (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥), –º–æ–∂–Ω–æ ¬´–ø—Ä–æ—Å–∫–æ—á–∏—Ç—å¬ª 50% –∏–ª–∏ 10% –∏ –Ω–µ –≤—ã–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–∏ –∫–∞–∂–¥–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —É—Ä–æ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å: `current_monster_hp <= 0.5 * stage_base_hp` –∏ —Ñ–ª–∞–≥ ¬´50% —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ —É–∂–µ –±—ã–ª–æ¬ª ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç, –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Ñ–ª–∞–≥. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è 10%. –ü–æ—Ä–æ–≥ —Å—á–∏—Ç–∞—Ç—å –æ—Ç `stage_base_hp` (–∏—Å—Ö–æ–¥–Ω—ã–π –º–∞–∫—Å. HP —Ç–µ–∫—É—â–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ), –∞ –Ω–µ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏.

#### 2.6. –¶–µ–ø–æ—á–∫–∞ `/engage`: ¬´‚â•2 —Ä–∞–∑–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤¬ª

- **–¢–ó:** –¶–µ–ø–æ—á–∫–∞ –∏–∑ 3 –∑–∞–¥–∞–Ω–∏–π; —É—Å–ø–µ—Ö —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ 3 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã **—Ä–∞–∑–Ω—ã–º–∏** –∏–≥—Ä–æ–∫–∞–º–∏ (–º–∏–Ω–∏–º—É–º 2, –ø–æ —Å–º—ã—Å–ª—É ‚Äî –¥–æ 3).
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –•—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–æ–±—ã—Ç–∏—è: `event_data = { "chain": [task1, task2, task3], "completed_by": [user_id1, user_id2, ...], "completed_tasks": [0, 1, 2] }`. –ó–∞–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–≤–ø–∞–ª –∏ user_id –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ –≤ —ç—Ç–æ–π —Ü–µ–ø–æ—á–∫–µ (–∏–ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –æ–¥–Ω–æ –∑–∞–¥–∞–Ω–∏–µ ‚Äî —É—Ç–æ—á–Ω–∏—Ç—å: ¬´2 —Ä–∞–∑–Ω—ã—Ö¬ª = –º–∏–Ω–∏–º—É–º 2 —á–µ–ª–æ–≤–µ–∫–∞ –≤ —Ü–µ–ø–æ—á–∫–µ, —Ç.–µ. 2 –∏–ª–∏ 3 —Ä–∞–∑–Ω—ã—Ö).

#### 2.7. –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–õ–°) —Å –Ω–∞–≥—Ä–∞–¥–æ–π

- **–¢–ó:** –ü–æ—Å–ª–µ –ø–æ–±–µ–¥—ã ‚Äî –Ω–∞–≥—Ä–∞–¥–∞ –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É –≤ –õ–° (–Ω–µ –≤ —á–∞—Ç).
- **–†–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ –∏–ª–∏ –Ω–µ –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ ‚Äî `send_message(chat_id=user_id)` –º–æ–∂–µ—Ç –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É.
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û—Ç–ø—Ä–∞–≤–∫—É –≤ –õ–° –¥–µ–ª–∞—Ç—å —Å try/except; –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –õ–° ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–µ –ø–∞–¥–∞—Ç—å; –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ –æ–±—â–∏–π —á–∞—Ç: ¬´–ß–∞—Å—Ç—å –Ω–∞–≥—Ä–∞–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –õ–°; –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –ø–∏—Å–∞–ª –≤–∞–º ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –õ–° —Å –±–æ—Ç–æ–º –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞¬ª (–∏–ª–∏ –≤—ã–¥–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —á–µ—Ä–µ–∑ API/–≤–µ–±).

#### 2.8. –í–∏–∑—É–∞–ª—å–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

- **–¢–ó:** –ë–æ—Ç –Ω–µ —É–¥–∞–ª—è–µ—Ç —á—É–∂–∏–µ –º–µ–¥–∏–∞; –ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–¥–∫—É –≤ —Å–≤–æ—ë–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏ —É–¥–∞–ª—è–µ—Ç **—Å–≤–æ—ë** —á–µ—Ä–µ–∑ 12 —Å–µ–∫.
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞/–ø—Ä–æ–≤–∞–ª–∞ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å `message_id`, –ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É (scheduler –∏–ª–∏ asyncio.sleep(12)) –∏ –≤—ã–∑–≤–∞—Ç—å `delete_message(chat_id, message_id)` —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–∞–≤–∞ –±–æ—Ç–∞: –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è ¬´—É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö¬ª.

---

### 3. –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è

| –ü—É–Ω–∫—Ç –¢–ó | –í–æ–ø—Ä–æ—Å | –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ |
|----------|--------|-------------|
| ¬´–£—Ä–æ–Ω –≤–∞–π—Ñ—É¬ª | –û—Ç–∫—É–¥–∞ –±—Ä–∞—Ç—å —á–∏—Å–ª–æ? | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ —Ä–∞—Å—á—ë—Ç, —á—Ç–æ –∏ –≤ —Å–æ–ª—å–Ω–æ–º –¥–∞–Ω–∂–µ (effective stats + weapon + media), –Ω–æ –±–µ–∑ —Ç—Ä–∞—Ç—ã —ç–Ω–µ—Ä–≥–∏–∏ –≤ GD; —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–¥–Ω–æ–≥–æ ¬´—É–¥–∞—Ä–∞¬ª –∫–∞–∫ –±–∞–∑–∞, –¥–∞–ª–µ–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –∫—Ä–µ–∞—Ç–∏–≤/—Å–æ–±—ã—Ç–∏–µ/–∞–¥–∞–ø—Ç–∞—Ü–∏—è. |
| ¬´–¶–∏—Ç–∞—Ç–∞ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞¬ª | –ö–∞–∫ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å? | –í Telegram —Å–æ–æ–±—â–µ–Ω–∏–µ —Å `reply_to_message` –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ –±–æ—Ç–∞) ‚Äî —Å—á–∏—Ç–∞—Ç—å –º–Ω–æ–∂–∏—Ç–µ–ª—å_–∫—Ä–µ–∞—Ç–∏–≤–∞ = 1.5. |
| –≠–º–æ–¥–∑–∏ —É—Ä–æ–Ω–∞ | ¬´üî•üí•‚ö°üí£¬ª ‚Äî —Ç–æ–ª—å–∫–æ —ç—Ç–∏ –∏–ª–∏ –ª—é–±—ã–µ –∏–∑ –Ω–∞–±–æ—Ä–∞? | –ó–∞–¥–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É —Å–ø–∏—Å–∫–∞ —ç–º–æ–¥–∑–∏; –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç–µ/–ø–æ–¥–ø–∏—Å–∏. |
| –ö–ª–∞—Å—Å ¬´–õ—É—á–Ω–∏–∫¬ª –≤ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –±–æ–Ω—É—Å–µ | –í WaifuClass –µ—Å—Ç—å ARCHER | –ú–∞–ø–ø–∏–Ω–≥: –õ—É—á–Ω–∏–∫ = ARCHER. |
| ¬´–¢–æ—Ä–≥–æ–≤—Ü—ã¬ª –≤ –±–æ–Ω—É—Å–∞—Ö | –í WaifuClass –µ—Å—Ç—å MERCHANT | –ú–∞–ø–ø–∏–Ω–≥: –¢–æ—Ä–≥–æ–≤–µ—Ü = MERCHANT. |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –¥–ª—è –±–æ–Ω—É—Å–∞ ¬´+1% –∑–∞ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω –±—ã—Å—Ç—Ä–µ–µ¬ª | ¬´–ü–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º 100 –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è–º –≥–ª–æ–±–∞–ª—å–Ω–æ¬ª | –¢–∞–±–ª–∏—Ü–∞ `gd_completions(chat_id, dungeon_template_id, started_at, finished_at)` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥; –ø—Ä–∏ –≤—ã–¥–∞—á–µ –Ω–∞–≥—Ä–∞–¥ —Å—á–∏—Ç–∞—Ç—å –º–µ–¥–∏–∞–Ω—É/—Å—Ä–µ–¥–Ω–µ–µ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º 100 –∑–∞–ø–∏—Å–µ–π –ø–æ —ç—Ç–æ–º—É dungeon_template_id, –∑–∞—Ç–µ–º —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è. |
| –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥—Ä–æ–ø—ã (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–∏–Ω–µ—Ä–≥–∏–∏) | –ù–µ—Ç –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ | –§–∞–∑–∞ 2: –≤–≤–µ—Å—Ç–∏ —à–∞–±–ª–æ–Ω—ã –ø—Ä–µ–¥–º–µ—Ç–æ–≤ ¬´—Ç–æ–ª—å–∫–æ –∏–∑ GD¬ª –∏ –¥—Ä–æ–ø-–ø—Ä–∞–≤–∏–ª–∞ –ø–æ —Ç–∏–ø—É –ø–æ–¥–∑–µ–º–µ–ª—å—è/–±–æ—Å—Å–∞. |

---

### 4. –°–≤–æ–¥–∫–∞ –ø–æ –ë–î (–∏–∑ –¢–ó + –∞–¥–∞–ø—Ç–∞—Ü–∏—è)

- **gd_sessions** ‚Äî –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–µ –≥—Ä—É–ø–ø–æ–≤–æ–µ –ø–æ–¥–∑–µ–º–µ–ª—å–µ –≤ —á–∞—Ç–µ:
  - `id` (PK), `chat_id` (unique –ø—Ä–∏ active), `dungeon_template_id`, `current_stage` (1..4), `current_monster_hp`, `stage_base_hp` (–¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –∏ 50%/10%), `started_at`, `last_activity_at`, `last_save_at`, `active_event_id`, `event_started_at`, `adaptive_regressions_count`, `event_50_done`, `event_10_done` (bool –ø–æ —ç—Ç–∞–ø–∞–º), `status` (active/completed).
- **gd_player_contributions** ‚Äî –≤–∫–ª–∞–¥ –∏–≥—Ä–æ–∫–∞ –≤ —Å–µ—Å—Å–∏—é:
  - `session_id`, `user_id`, `total_damage`, `events_completed`, `joined_at_stage`, `joined_at`, `damage_multiplier` (0.7 / 1.0).
- **gd_dungeon_templates** (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Dungeon —Å type=GROUP):
  - –ü–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ, –º–Ω–æ–∂–∏—Ç–µ–ª—å_–•–ü, —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π_–±–æ–Ω—É—Å_–æ–ø–∏—Å–∞–Ω–∏–µ, —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ_—Å–æ–±—ã—Ç–∏–µ_id/—Ç–∏–ø.
- **event_templates** ‚Äî —à–∞–±–ª–æ–Ω—ã —Å–æ–±—ã—Ç–∏–π (T1..T6, G1..G14, C1..C9, emoji_filter, min_players_required, duration_seconds, weight).
- **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ª–∏–±–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã `chat_activity`, `player_chat_first_seen`, `player_game_actions`, –ª–∏–±–æ Redis + –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä —Ç–æ–ª—å–∫–æ first_seen –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫ GD –ø–æ —á–∞—Ç—É).

---

## –ß–∞—Å—Ç—å II. –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 0. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (—Å—Ö–µ–º–∞ –∏ –¥–∞–Ω–Ω—ã–µ)

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î**
   - –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã: `gd_sessions`, `gd_player_contributions`, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ `gd_dungeon_templates` (–∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å `dungeons` –ø–æ–¥ GD).
   - –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: `player_chat_first_seen`, `player_game_actions` (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –ø–æ player_id, chat_id, created_at).
   - –¢–∞–±–ª–∏—Ü–∞ `event_templates` ‚Äî –ø–æ–¥ —Ç—Ä–∏–≥–≥–µ—Ä—ã T1..T6, —Ç–∏–ø—ã —Ü–µ–ª–µ–π/–∫–æ–Ω—Ç–µ–Ω—Ç–∞/—ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
   - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏: `gd_completions` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è (–Ω–∞–≥—Ä–∞–¥–∞ ¬´–±—ã—Å—Ç—Ä–µ–µ —Å—Ä–µ–¥–Ω–µ–≥–æ¬ª).

2. **–°–∏–¥—ã**
   - 5 —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–¥–∑–µ–º–µ–ª–∏–π (–í–æ–∑–¥—É—à–Ω–∞—è –∫—Ä–µ–ø–æ—Å—Ç—å, –ì–ª—É–±–∏–Ω–Ω—ã–π —Ä–∏—Ñ, –ü—É—Å—Ç—ã–Ω—è –∑–∞–±–≤–µ–Ω–∏—è, –õ–∞–±–∏—Ä–∏–Ω—Ç –∑–µ—Ä–∫–∞–ª, –ß–∞—Å–æ–≤–Ω—è –≤—Ä–µ–º–µ–Ω–∏) —Å –º–Ω–æ–∂–∏—Ç–µ–ª—è–º–∏ –•–ü –∏ –ø—Ä–∏–≤—è–∑–∫–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
   - –ü—É–ª –º–æ–Ω—Å—Ç—Ä–æ–≤ –¥–ª—è GD: 3 –æ–±—ã—á–Ω—ã—Ö + 1 –±–æ—Å—Å –Ω–∞ –ø–æ–¥–∑–µ–º–µ–ª—å–µ (–∏–ª–∏ –æ–±—â–∏–π –ø—É–ª —Å —Ç–µ–≥–∞–º–∏ –ø–æ–¥ —Ç–µ–º–∞—Ç–∏–∫—É).
   - –ó–∞–ø–æ–ª–Ω–∏—Ç—å `event_templates` –¥–ª—è –æ–±—â–∏—Ö (50%/10%), —Ü–µ–ø–æ—á–∫–∏ `/engage`, —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –±–æ—Å—Å–∞.

3. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –º–∞–ø–ø–∏–Ω–≥**
   - –í—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã: –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –•–ü –ø–æ –ø–æ–¥–∑–µ–º–µ–ª—å—è–º, —ç–º–æ–¥–∑–∏ —É—Ä–æ–Ω–∞/—Ö–∏–ª–∞/—â–∏—Ç–∞, –ª–∏–º–∏—Ç—ã (8 —Å–µ–∫, 5 —Å–∏–º–≤–æ–ª–æ–≤, 2 —á–∞—Å–∞, 25 –º–∏–Ω, 90 —Å–µ–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏, 75 –º–∏–Ω —Ñ–æ—Ä—Å-–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è).
   - –ú–∞–ø–ø–∏–Ω–≥ WaifuClass ‚Üí ¬´–¢–∞–Ω–∫ / DPS / –ü–æ–¥–¥–µ—Ä–∂–∫–∞¬ª –¥–ª—è –±–æ–Ω—É—Å–∞ ¬´–≤—Å–µ 3 —Ç–∏–ø–∞ –≤ –≥—Ä—É–ø–ø–µ¬ª.

---

### –§–∞–∑–∞ 1. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–≤–æ –Ω–∞ –∑–∞–ø—É—Å–∫

1. **–°–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**
   - –ü—Ä–∏ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ –≥—Ä—É–ø–ø–µ (–≥–¥–µ –≤–∫–ª—é—á—ë–Ω –±–æ—Ç): –æ–±–Ω–æ–≤–ª—è—Ç—å Redis (—Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 60 –º–∏–Ω –ø–æ chat_id).
   - –ü—Ä–∏ –∏–≥—Ä–æ–≤–æ–º –¥–µ–π—Å—Ç–≤–∏–∏ (—É—Ä–æ–Ω –≤ GD, —É—á–∞—Å—Ç–∏–µ –≤ —Å–æ–±—ã—Ç–∏–∏, `/gd_start`, `/engage`): –ø–∏—Å–∞—Ç—å –≤ `player_game_actions` –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å `player_chat_first_seen` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—è–≤–ª–µ–Ω–∏–∏.
   - –§—É–Ω–∫—Ü–∏–∏: `get_chat_message_rate(chat_id)`, `get_active_players_24h(chat_id)`, `is_player_eligible_for_gd_start(player_id, chat_id)` (‚â•3 –¥–Ω—è –≤ —á–∞—Ç–µ, ‚â•2 –∏–≥—Ä–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è –∑–∞ 7 –¥–Ω–µ–π).

2. **–ö–æ–º–∞–Ω–¥–∞ `/gd_start`**
   - –ü—Ä–æ–≤–µ—Ä–∫–∏: –ø–æ–¥–∑–µ–º–µ–ª—å–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ –≤ —á–∞—Ç–µ; –∫—É–ª–¥–∞—É–Ω —á–∞—Ç–∞ 60 –º–∏–Ω –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–±–µ–¥—ã; –∫—É–ª–¥–∞—É–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2 —á; –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á–∞—Ç–∞ ‚â•4 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –∑–∞ 60 –º–∏–Ω –∏ ‚â•3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞ –∑–∞ 24 —á; –∏–≥—Ä–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º.
   - –ï—Å–ª–∏ –ø–æ–¥–∑–µ–º–µ–ª—å–µ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ: –∑–∞–¥–µ—Ä–∂–∫–∞ 10+ —Å–µ–∫, –æ—Ç–≤–µ—Ç ¬´–ü–æ–¥–∑–µ–º–µ–ª—å–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –±–∏—Ç–≤–µ —Å [–º–æ–Ω—Å—Ç—Ä]¬ª.
   - –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: —Å–æ–∑–¥–∞—Ç—å `gd_sessions`, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 4 —ç—Ç–∞–ø–∞ (3 –º–æ–Ω—Å—Ç—Ä–∞ + –±–æ—Å—Å), –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º (üü¢üü¢üü¢üî¥), –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/—Ä–µ–≥—Ä–µ—Å—Å–∏—é –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞.

---

### –§–∞–∑–∞ 2. –£—Ä–æ–Ω –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º –≤ GD

1. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**
   - –í `bot_handlers`: –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ group/supergroup —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π `gd_sessions` –ø–æ `chat_id`. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Äî –≤—ã–∑—ã–≤–∞—Ç—å `gd_service.on_chat_message(...)` –∏ –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å —Å–æ–ª—å–Ω—ã–π `combat_service.process_message_damage` –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–ª–∏ –≤—ã–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ GD –Ω–µ—Ç ‚Äî —á—Ç–æ–±—ã —Å–æ–ª—å–Ω—ã–π –¥–∞–Ω–∂ –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ –º–µ—à–∞–ª; —É—Ç–æ—á–Ω–∏—Ç—å: —Å–æ–ª—å–Ω—ã–π –¥–∞–Ω–∂ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ player, –≤ —á–∞—Ç–µ –æ–±—ã—á–Ω–æ —Ç–æ–ª—å–∫–æ GD).
   - –õ–æ–≥–∏–∫–∞: –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Å–æ–ª—å–Ω—ã–π run –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ GD –≤ —á–∞—Ç–µ; —É—Ä–æ–Ω –≤ —á–∞—Ç–µ –∏–¥—ë—Ç —Ç–æ–ª—å–∫–æ –≤ GD, –≤ –≤–µ–± ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Å–æ–ª—å–Ω—ã–π run.

2. **–†–∞—Å—á—ë—Ç —É—Ä–æ–Ω–∞ GD**
   - –ü–æ–ª—É—á–∏—Ç—å waifu –∏–≥—Ä–æ–∫–∞, effective damage (–∫–∞–∫ –≤ combat, –±–µ–∑ —Ç—Ä–∞—Ç—ã —ç–Ω–µ—Ä–≥–∏–∏).
   - –ú–Ω–æ–∂–∏—Ç–µ–ª—å –∫—Ä–µ–∞—Ç–∏–≤–∞: 1.0 (—Ç–µ–∫—Å—Ç ‚â•5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤), 1.2 (—ç–º–æ–¥–∑–∏ —É—Ä–æ–Ω–∞), 1.5 (reply –Ω–∞ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞).
   - –ú–Ω–æ–∂–∏—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è: 1.0 –∏–ª–∏ 1.8 –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –±–∞—Ñ—Ñ —Å–æ–±—ã—Ç–∏—è (60‚Äì90 —Å–µ–∫).
   - –ú–Ω–æ–∂–∏—Ç–µ–ª—å –∞–¥–∞–ø—Ç–∞—Ü–∏–∏: 0.7 –µ—Å–ª–∏ `joined_at` < 5 –º–∏–Ω –Ω–∞–∑–∞–¥, –∏–Ω–∞—á–µ 1.0.
   - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞: –º–∏–Ω–∏–º—É–º 5 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏; –∏–≥–Ω–æ—Ä –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 2 —Å–æ–æ–±—â–µ–Ω–∏–π —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞; –º–∞–∫—Å. 1 —É—á—ë—Ç —Ä–∞–∑ –≤ 8 —Å–µ–∫ –Ω–∞ –∏–≥—Ä–æ–∫–∞ (Redis).
   - –ú–µ–¥–∏–∞: —Å—á–∏—Ç–∞—Ç—å –∫–∞–∫ 1 –¥–µ–π—Å—Ç–≤–∏–µ, –º–Ω–æ–∂–∏—Ç–µ–ª—å –∫—Ä–µ–∞—Ç–∏–≤–∞ –Ω–µ –≤—ã—à–µ 1.2.

3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏**
   - –í—ã—á–µ—Å—Ç—å —É—Ä–æ–Ω –∏–∑ `current_monster_hp`; –æ–±–Ω–æ–≤–∏—Ç—å `last_activity_at`; –¥–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–Ω –≤ `gd_player_contributions` –¥–ª—è —ç—Ç–æ–≥–æ user_id (—Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —É–¥–∞—Ä–µ, –µ—Å–ª–∏ –Ω–µ—Ç); –ø—Ä–∏ —Å–º–µ–Ω–µ —ç—Ç–∞–ø–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞–ø–∏—Å–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–≤—à–∏—Ö—Å—è —Å `joined_at_stage` –∏ `damage_multiplier` –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

4. **–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ**
   - –ü—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞ –≤ —á–∞—Ç–µ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ `gd_player_contributions` —Å `joined_at` = now, `joined_at_stage` = current_stage, `damage_multiplier` = 0.7; —á–µ—Ä–µ–∑ 5 –º–∏–Ω –æ–±–Ω–æ–≤–∏—Ç—å multiplier –Ω–∞ 1.0 (–ø–æ —Ç–∞–π–º–µ—Ä—É –∏–ª–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —É–¥–∞—Ä–µ).

---

### –§–∞–∑–∞ 3. –°–æ–±—ã—Ç–∏—è

1. **–¢—Ä–∏–≥–≥–µ—Ä—ã 50% –∏ 10%**
   - –ü—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —É—Ä–æ–Ω–∞ (–∏ –ø—Ä–∏ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏) –ø—Ä–æ–≤–µ—Ä—è—Ç—å: `current_monster_hp <= 0.5 * stage_base_hp` –∏ —Ñ–ª–∞–≥ —Å–æ–±—ã—Ç–∏—è 50% –¥–ª—è —ç—Ç–∞–ø–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Üí –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ (–≤—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω –ø–æ —Ç–∏–ø—É), –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Ñ–ª–∞–≥; –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è 10%.
   - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 45‚Äì60 —Å–µ–∫; —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ; –ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏—è –∫—É–ª–¥–∞—É–Ω 15 —Å–µ–∫.

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π (–æ–±—â–∏–µ)**
   - –ü–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è: –©–∏—Ç (—Ç–∞–Ω–∫–∏, —Å—Ç–∏–∫–µ—Ä/—ç–º–æ–¥–∑–∏ üõ°Ô∏è/‚öîÔ∏è), –ò—Å—Ü–µ–ª–µ–Ω–∏–µ (–ª–µ–∫–∞—Ä–∏, üíö/‚ù§Ô∏è/‚ú® –∏–ª–∏ —Ç–µ–∫—Å—Ç ¬´—Ö–∏–ª¬ª/¬´–ª–µ—á–µ–Ω–∏–µ¬ª), –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä—ã–≤–æ–∫ (–≤—Å–µ, —Ç–µ–∫—Å—Ç ‚â•15 —Å–∏–º–≤–æ–ª–æ–≤ + üí•/üî•).
   - –°–±–æ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π: –≤ —Ç–µ—á–µ–Ω–∏–µ 45‚Äì60 —Å–µ–∫ —É—á–∏—Ç—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤; –ø—Ä–∏ —É—Å–ø–µ—Ö–µ ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å –±–∞—Ñ—Ñ (√ó1.8 —É—Ä–æ–Ω–∞ –Ω–∞ 60 —Å–µ–∫ –∏ —Ç.–¥.), –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–¥–∫—É –≤ —á–∞—Ç —Å –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ 12 —Å–µ–∫.

3. **–ö–æ–º–∞–Ω–¥–∞ `/engage`**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫—É–ª–¥–∞—É–Ω 25 –º–∏–Ω –Ω–∞ —á–∞—Ç (Redis –∏–ª–∏ –ø–æ–ª–µ –≤ gd_sessions); –≤ –±–æ–ª—å—à–∏—Ö —á–∞—Ç–∞—Ö (>500) ‚Äî 40 –º–∏–Ω; —Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞; –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
   - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ø–æ—á–∫—É –∏–∑ 3 –∑–∞–¥–∞–Ω–∏–π (–∫–ª–∞—Å—Å/—Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞/—ç–º–æ–¥–∑–∏), –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç.
   - –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏–π —Ä–∞–∑–Ω—ã–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏ (‚â•2): –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∏ —á—Ç–æ user_id –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –∑–∞–¥–∞–Ω–∏—è; –ø—Ä–∏ —É—Å–ø–µ—Ö–µ –≤—Å–µ—Ö —Ç—Ä—ë—Ö ‚Äî ‚àí35% HP —Ç–µ–∫—É—â–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞.

4. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –±–æ—Å—Å–∞**
   - –ü—Ä–∏ current_stage == 4 –∏ HP –±–æ—Å—Å–∞ ‚â§ 40%: –∑–∞–ø—É—Å—Ç–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø–æ —à–∞–±–ª–æ–Ω—É –ø–æ–¥–∑–µ–º–µ–ª—å—è (–í–∏—Ö—Ä—å, –ü—Ä–∏–ª–∏–≤, –û–∞–∑–∏—Å, –û—Ç—Ä–∞–∂–µ–Ω–∏–µ, –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ).
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ –ø–æ –¢–ó (–∫–æ–ª-–≤–æ –∏–≥—Ä–æ–∫–æ–≤, —ç–º–æ–¥–∑–∏, –≥–æ–ª–æ—Å–æ–≤—ã–µ, —Ü–µ–ø–æ—á–∫–∞ –∫–ª–∞—Å—Å–æ–≤).

5. **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**
   - –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å <2 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 120+ —Å–µ–∫ ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–æ–±—ã—Ç–∏—è –Ω–∏–∑–∫–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–∑–∞–¥–∞—Ç—å –≤ event_templates).

---

### –§–∞–∑–∞ 4. –§–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫**
   - –¶–∏–∫–ª –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º `gd_sessions`: –æ–±–Ω–æ–≤–∏—Ç—å `current_monster_hp`, `last_save_at`, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è; commit.

2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è**
   - –ö–∞–∂–¥—ã–µ 90 —Å–µ–∫ (–∏–ª–∏ –≤ —Ç–æ–º –∂–µ —Ü–∏–∫–ª–µ): –¥–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 —Å–µ–∫; –µ—Å–ª–∏ < 3 (—Ç.–µ. < 2/–º–∏–Ω) ‚Äî –≤—ã—á–µ—Å—Ç—å 1.2% –æ—Ç `stage_base_hp`, —É–≤–µ–ª–∏—á–∏—Ç—å `adaptive_regressions_count`, –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ —á–∞—Ç.

3. **–§–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**
   - –ï—Å–ª–∏ `started_at` —Å—Ç–∞—Ä—à–µ 75 –º–∏–Ω –∏ `current_monster_hp > 0.05 * stage_base_hp` ‚Äî –æ–±–Ω—É–ª–∏—Ç—å HP, –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–±–µ–¥—É –Ω–∞–¥ –º–æ–Ω—Å—Ç—Ä–æ–º/–±–æ—Å—Å–æ–º –∫–∞–∫ –æ–±—ã—á–Ω–æ.

4. **–°–º–µ–Ω–∞ —ç—Ç–∞–ø–∞ –∏ –ø–æ–±–µ–¥–∞**
   - –ü—Ä–∏ `current_monster_hp <= 0`: –µ—Å–ª–∏ —ç—Ç–∞–ø < 4 ‚Äî –ø–∞—É–∑–∞ 15 —Å–µ–∫, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ, –æ–±–Ω–æ–≤–∏—Ç—å stage, –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–æ–Ω—Å—Ç—Ä–∞ (base_hp, name), —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥–∏ 50%/10%. –ï—Å–ª–∏ —ç—Ç–∞–ø == 4 ‚Äî –ø–æ–±–µ–¥–∞ –Ω–∞–¥ –±–æ—Å—Å–æ–º: —Ä–∞—Å—á—ë—Ç –Ω–∞–≥—Ä–∞–¥, —Ä–∞—Å—Å—ã–ª–∫–∞ –≤ –õ–°, –∑–∞–ø–∏—Å—å –≤ gd_completions, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞ —á–∞—Ç–∞ 60 –º–∏–Ω.

---

### –§–∞–∑–∞ 5. –ù–∞–≥—Ä–∞–¥—ã

1. **–†–∞—Å—á—ë—Ç –≤–∫–ª–∞–¥–∞**
   - –î–æ–ª—è —É—Ä–æ–Ω–∞ –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –æ—Ç –æ–±—â–µ–≥–æ –ø–æ –≤—Å–µ–º —ç—Ç–∞–ø–∞–º.
   - –ë–æ–Ω—É—Å—ã: +15% –∑–∞ –∫–∞–∂–¥–æ–µ —É—Å–ø–µ—à–Ω–æ–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ; +10% –µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–µ –±—ã–ª–∏ –≤—Å–µ 3 —Ç–∏–ø–∞ –∫–ª–∞—Å—Å–æ–≤; +1% –∑–∞ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω –±—ã—Å—Ç—Ä–µ–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (–ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º 100 –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è–º —ç—Ç–æ–≥–æ —à–∞–±–ª–æ–Ω–∞).

2. **–í—ã–¥–∞—á–∞**
   - –û–ø—ã—Ç, –º–æ–Ω–µ—Ç—ã, –ø—Ä–µ–¥–º–µ—Ç (—Ä–µ–¥–∫–æ—Å—Ç—å –ø–æ –¥–æ–ª–µ/—É–¥–∞—á–µ), –±–∞—Ñ—Ñ –Ω–∞ 24 —á ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î –∏–≥—Ä–æ–∫–∞ (–æ–ø—ã—Ç –≤–∞–π—Ñ—É, gold, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, –±–∞—Ñ—Ñ—ã). –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –õ–° —Ç–µ–∫—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω—É –∏–∑ –¢–ó.

---

### –§–∞–∑–∞ 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º –∏ UX

1. **–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –±–æ—Ç–∞**
   - –ü–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ —á–∞—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –≤ —ç—Ç–æ—Ç chat_id (Redis); –µ—Å–ª–∏ < 10 —Å–µ–∫ ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π.

2. **–ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–¥–æ–∫**
   - –ü–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏—è: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 12 —Å–µ–∫ (asyncio.sleep –∏–ª–∏ scheduler).

3. **–†–µ–π—Ç-–ª–∏–º–∏—Ç `/gd_start`**
   - Redis –∫–ª—é—á `gd_start_cooldown:{user_id}` —Å TTL 2 —á–∞—Å–∞; –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Ä–∞–Ω—å—à–µ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–ø–æ–¥–æ–∂–¥–∏ –¥–æ HH:MM¬ª.

---

### –§–∞–∑–∞ 7. –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–≤–∫–ª–∞–¥–∫–∞ ¬´–ì—Ä—É–ø–ø–æ–≤—ã–µ¬ª)

1. **API**
   - `GET /gd/status` (–∏–ª–∏ `/dungeons/group/status`): –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤–µ—Ä–Ω—É—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é GD-—Å–µ—Å—Å–∏—é –≤ —á–∞—Ç–∞—Ö, –≥–¥–µ –æ–Ω —É—á–∞—Å—Ç–≤—É–µ—Ç (–Ω—É–∂–Ω–∞ –ø—Ä–∏–≤—è–∑–∫–∞ player_id ‚Üí chat_id: –ª–∏–±–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ gd_player_contributions, –ª–∏–±–æ –æ—Ç–¥–µ–ª—å–Ω–æ ¬´—á–∞—Ç—ã –∏–≥—Ä–æ–∫–∞¬ª ‚Äî —Å–ª–æ–∂–Ω–µ–µ; –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø–æ —Ç–µ–∫—É—â–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π GD, –∞ —Ç–æ–ª—å–∫–æ ¬´–∑–∞–ø—É—Å–∫–∞–π—Ç–µ –≤ Telegram –∫–æ–º–∞–Ω–¥–æ–π /gd_start¬ª –∏ –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π –ø–æ –∏–≥—Ä–æ–∫—É).
   - –£–ø—Ä–æ—â–µ–Ω–∏–µ: –≤–∫–ª–∞–¥–∫–∞ ¬´–ì—Ä—É–ø–ø–æ–≤—ã–µ¬ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∫–∏, —Ç–µ–∫—Å—Ç ¬´–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–µ –ø–æ–¥–∑–µ–º–µ–ª—å–µ, –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ Telegram –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /gd_start¬ª –∏ —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–∞–≥—Ä–∞–¥ GD –ø–æ —ç—Ç–æ–º—É –∏–≥—Ä–æ–∫—É (–∏–∑ –ª–æ–≥–æ–≤ –∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã gd_rewards_log).

2. **–ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏**
   - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: 4 —ç—Ç–∞–ø–∞, —Å–æ–±—ã—Ç–∏—è, –Ω–∞–≥—Ä–∞–¥—ã.
   - –ö–Ω–æ–ø–∫–∞/—Å—Å—ã–ª–∫–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –±–æ—Ç–æ–º¬ª (t.me/bot?start=group_dungeon).
   - –ë–ª–æ–∫ ¬´–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã¬ª: –¥–∞—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∑–µ–º–µ–ª—å—è, –≤–∫–ª–∞–¥ %, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ–ø—ã—Ç/–º–æ–Ω–µ—Ç—ã/–ø—Ä–µ–¥–º–µ—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å API).

---

### –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–∫—Ä–∞—Ç–∫–æ)

1. –§–∞–∑–∞ 0: –º–∏–≥—Ä–∞—Ü–∏–∏, —Å–∏–¥—ã, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã.  
2. –§–∞–∑–∞ 1: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å + `/gd_start` —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏.  
3. –§–∞–∑–∞ 2: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí GD, —Ñ–æ—Ä–º—É–ª–∞ —É—Ä–æ–Ω–∞, –≤–∫–ª–∞–¥, –∞–Ω—Ç–∏—Å–ø–∞–º.  
4. –§–∞–∑–∞ 4 (–±–∞–∑–æ–≤–æ): —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ 30 —Å–µ–∫, —Ä–µ–≥—Ä–µ—Å—Å–∏—è, —Å–º–µ–Ω–∞ —ç—Ç–∞–ø–∞ –∏ –ø–æ–±–µ–¥–∞ (–±–µ–∑ —Å–æ–±—ã—Ç–∏–π).  
5. –§–∞–∑–∞ 3: —Å–æ–±—ã—Ç–∏—è 50%/10%, `/engage`, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –±–æ—Å—Å–∞, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ.  
6. –§–∞–∑–∞ 5: –Ω–∞–≥—Ä–∞–¥—ã –∏ –õ–°.  
7. –§–∞–∑–∞ 6: —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥ –±–æ—Ç–∞, –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ, –∫—É–ª–¥–∞—É–Ω—ã.  
8. –§–∞–∑–∞ 7: –≤–∫–ª–∞–¥–∫–∞ ¬´–ì—Ä—É–ø–ø–æ–≤—ã–µ¬ª –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

–ü–æ—Å–ª–µ –§–∞–∑—ã 2 –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –§–∞–∑—ã 4 —É–∂–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å GD ¬´—Ç—É–ø–æ¬ª —É—Ä–æ–Ω–æ–º –∏ —Ä–µ–≥—Ä–µ—Å—Å–∏–µ–π –±–µ–∑ —Å–æ–±—ã—Ç–∏–π; –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –∏ –Ω–∞–≥—Ä–∞–¥—ã.

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –º–∞–ø–ø–∏–Ω–≥ –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è –±–æ–Ω—É—Å–æ–≤

| –¢–ó | WaifuClass |
|----|------------|
| –¢–∞–Ω–∫ (–†—ã—Ü–∞—Ä—å/–í–æ–∏–Ω) | KNIGHT, WARRIOR |
| –õ—É—á–Ω–∏–∫ | ARCHER |
| –ú–∞–≥ | MAGE |
| –õ–µ–∫–∞—Ä—å | HEALER |
| –¢–æ—Ä–≥–æ–≤–µ—Ü | MERCHANT |
| DPS (–ø—Ä–æ—á–∏–µ) | ASSASSIN (+ ARCHER, MAGE –¥–ª—è —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±–æ–Ω—É—Å–æ–≤) |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | HEALER, MERCHANT |

–¢–∏–ø—ã –¥–ª—è –±–æ–Ω—É—Å–∞ ¬´–≤—Å–µ 3 —Ç–∏–ø–∞ –≤ –≥—Ä—É–ø–ø–µ¬ª: –¢–∞–Ω–∫ = KNIGHT|WARRIOR; DPS = ARCHER|MAGE|ASSASSIN; –ü–æ–¥–¥–µ—Ä–∂–∫–∞ = HEALER|MERCHANT.
