# Настройка тестового режима GD

Пошаговая настройка для работы команд отладки (`/gd_debug`, `/gd_test_start` и др.) в тестовом чате.

---

## 1. Переменные для .env

Добавьте в ваш `.env` (или создайте из `.env.example`):

```env
# Тестовый режим: команды отладки доступны только при APP_ENV=testing
APP_ENV=testing

# Ваш Telegram user_id (админ/разработчик). Уровень 4 = полный доступ.
DEV_USER_IDS=305174198
DEV_ACCESS_LEVELS=305174198:4

# ID чата, в котором разрешены команды отладки (только этот чат, если задано).
TEST_CHAT_IDS=-1004955648634
```

- **ID чата:** `-1004955648634`  
- **ID администратора:** `305174198`  

Остальные переменные (`BOT_TOKEN`, `POSTGRES_DSN`, `REDIS_URL`, `WEBHOOK_SECRET`, `PUBLIC_BASE_URL`) должны быть уже заданы в `.env`.

---

## 2. Запуск в тестовом режиме

```bash
# Из корня проекта, с учётом того что конфиг читается из .env
python -m waifu_bot.cli run --env testing
```

Либо в `.env` задать `APP_ENV=testing` и запускать как обычно (например, `uvicorn`); тогда команды отладки будут доступны при выполнении условий ниже.

---

## 3. Условия работы команд отладки

Команды срабатывают только если **все** условия выполнены:

| Условие | Проверка |
|--------|-----------|
| Режим тестирования | В `.env`: `APP_ENV=testing` (или запуск с `run --env testing`) |
| Вы в списке разработчиков | Ваш Telegram ID в `DEV_USER_IDS` (например, `305174198`) |
| Чат в белом списке | Либо `TEST_CHAT_IDS` пустой, либо ID чата в `TEST_CHAT_IDS` (например, `-1004955648634`) |

Если бот не реагирует на `/gd_debug` или `/gd_test_start`:

1. Проверьте, что **Privacy Mode** у бота выключен: в @BotFather → `/setprivacy` → ваш бот → **Disable**.
2. Убедитесь, что бот добавлен в чат и является **администратором** (хотя бы право «Отправлять сообщения»).
3. Проверьте логи сервера при отправке команды в чат (ошибки вебхука, 403 и т.д.).

---

## 4. Проверка

В чате с ID `-1004955648634` от пользователя с ID `305174198`:

1. `/gd_debug` — должна прийти сводка по текущей GD-сессии или сообщение «Нет активной GD-сессии».
2. `/gd_test_start 1` — запуск тестового подземелья (шаблон 1) без проверок активности.

Если приходит «Команды отладки разрешены только в тестовых чатах» — проверьте, что в `TEST_CHAT_IDS` указан ровно ID вашего чата: `-1004955648634` (с минусом, без кавычек).

---

## 5. Подсказки команд в Telegram (по желанию)

В @BotFather: `/setcommands` → выберите бота → можно добавить, например:

```
start - Начать
gd_start - Запустить групповое подземелье
gd_debug - Отладка (только тестовый режим)
gd_test_start - Тест подземелья (только тестовый режим)
help - Помощь
```

Команды отладки лучше не показывать в общем списке или использовать только в тестовом чате.
