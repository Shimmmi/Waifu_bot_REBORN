# Документ: отображение предметов в магазине (имена + модалка) на базе инвентаря

## Цель

Сделать отображение предметов в магазине **аналогичным инвентарю**:
- карточка в гриде показывает **правильное имя** (с учётом аффиксов/суффиксов),
- модальная карточка показывает **статы/бонусы**,
- в магазине **нет** кнопок `экипировать/снять`, но есть **цена** и **кнопка «Купить»**,
- корректная обработка «продано»/пустых слотов.

---

## Текущее поведение (как было)

### Инвентарь (работает)
- Фронтенд использует `display_name` (если есть) или собирает имя через `composeItemDisplayName(item)` на основе:
  - `item.name` (база),
  - `item.affixes[]` с `kind` = `affix` (префикс) / `suffix` (суффикс).
- Модалка инвентаря (`openItemModal`) показывает:
  - иконку (заглушка-эмодзи через `itemArtHtml`),
  - редкость,
  - итоговое имя,
  - параметры оружия (`renderWeaponStatsHtml`),
  - бонусы (`renderItemBonusesHtml`),
  - кнопки экипировки/снятия (контекст **инвентаря**).

### Магазин (сломано)
- Карточка оффера показывала `offer.name` и часто была **«Предмет»**.
- Модалка магазина показывала только tier/цену и «Оффер пока без деталей».

---

## Причины проблемы

### 1) Несовпадение семантики `kind`
- В инвентаре и на фронте `kind` = `affix` / `suffix`.
- В магазине на бэке при сборке имени использовались значения `prefix` / `suffix`.
- Это приводило к тому, что префиксы игнорировались (или вообще не формировалось отображаемое имя как в инвентаре).

### 2) В магазин не отдавались структурированные аффиксы
- Для модалки магазина фронтенду нужны данные вида:
  - `affixes[]: { name, kind, stat, value, is_percent }`
  - `base_stat`, `base_stat_value`
  - `damage_min/max`, `attack_speed`, `attack_type`, `weapon_type`
- В инвентаре этот формат уже используется рендерерами `renderItemBonusesHtml` и `renderWeaponStatsHtml`.
- В магазине отдавалось только `name` строкой + часть полей → модалка не могла показать «как в инвентаре».

---

## Решение (контракт + UI)

### API: `/shop/inventory`

Для каждого оффера возвращаем:
- **`display_name`**: итоговое имя (префиксы + база + суффиксы)
- **`name`**: можно оставить равным `display_name` (для обратной совместимости)
- **`affixes`**: список аффиксов в фронтенд-формате:
  - `kind`: `affix` | `suffix`
  - `stat`: строковый ключ стата
  - `value`: число (int)
  - `is_percent`: bool
  - `name`: текстовая метка (для потенциального UI)
- оружейные поля + базовый стат:
  - `damage_min`, `damage_max`, `attack_speed`, `attack_type`, `weapon_type`
  - `base_stat`, `base_stat_value`
  - `slot_type` (для выбора заглушки-эмодзи)
- магазинные поля:
  - `price`
  - `sold` (если уже куплено)

### UI: карточки магазина (grid)

Правило отображения:
- `title` и подпись — `display_name || name || "Предмет"`
- иконка: `itemArtHtml(offer)` (эмодзи по `slot_type/weapon_type`)
- если `sold=true`:
  - визуально как «пусто/disabled» (класс `empty`),
  - не открывать модалку по клику,
  - текст «Продано».

### UI: модалка магазина

Модалка магазина (`shop-modal`) должна:
- показывать:
  - `rarityLabel(offer.rarity)`
  - `display_name`
  - `lvl N`
  - `price`
  - параметры оружия: `renderWeaponStatsHtml(offer)`
  - бонусы: `renderItemBonusesHtml(offer)`
- **не** показывать:
  - `Экипировать` / `Снять`
- кнопка `Купить`:
  - `disabled`, если `sold=true` или `price==null`.

---

## Изменения в коде (сводка)

### Бэкенд
- `services/shop.py`
  - исправить обработку `InventoryAffix.kind` (использовать `affix` вместо `prefix`)
  - добавить `display_name`
  - сериализовать `affixes[]` для фронта

### Фронтенд
- `webapp/app.js`
  - `loadShop`: использовать `display_name`, `itemArtHtml`, учитывать `sold`
  - `openShopOffer`: рендерить `renderWeaponStatsHtml` + `renderItemBonusesHtml`, нормальную `rarityLabel`, блокировать покупку если `sold`

---

## Тест-план (ручной)

1. Открыть `shop.html`, убедиться что:
   - имена не «Предмет», а «Мудрый амулет», «Быстрый посох» и т.п.
   - у карточек корректный emoji по типу слота.
2. Открыть модалку предмета в магазине:
   - есть редкость/уровень/цена,
   - есть блок «Параметры» (для оружия),
   - есть блок «Бонусы» (для base_stat и аффиксов).
3. Купить предмет:
   - оффер становится «Продано»,
   - кнопка «Купить» недоступна для проданного слота,
   - предмет появляется в инвентаре.

