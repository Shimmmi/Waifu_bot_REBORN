# Waifu_bot_REBORN — техническое задание (актуализировано)

Статус: черновик с возможностью дальнейшего баланса.  
Админ Telegram ID: `305174198`.  
Bot token указан в окружении/секретах (не храним в коде).

## Архитектура и стек
- Telegram Bot (webhook) + REST API для WebApp + SSE.
- Python, Postgres, Redis, SSE.
- WebApp: HTML/CSS по зданиям/актам, роутинг зависит от текущего акта.
- Webhook: `/tg/webhook?token=<secret>` с проверкой секретного токена, идемпотентность по `update_id`.
- Авторизация WebApp: проверка `initData` Telegram, выдача сессионного токена (Redis).
- Redis: сессии WebApp (TTL 30 мин), контекст чата (TTL 24 ч), боевые состояния (TTL 1 ч), кэш витрин магазина (TTL 1 ч).
- Бэкапы Postgres: ежедневно, ретеншен 7–14 дней (уточнить).
- Миграции: Alembic.

## Игровые сущности (ключевое)
- Основная вайфу (main_Waifu): раса (7), класс (7, 3 архетипа), статы СИЛ/ЛОВ/ИНТ/ВЫН/ОБА/УДЧ. Базовые для человека: 10; итог = 10 + бонус расы + бонус класса.
- Наёмные вайфу (hired_Waifu): нанимаются в таверне, базовый уровень 1. Если резерв переполнен и вайфу уволена, новая может принять уровень уволенной (сохранение прогресса), иначе уровень 1. Редкость/статы по весам редкостей.
- Акты: 5 актов. Переход через Караван после финального данжа акта. Акт влияет на ассеты, уровни лута и шансы редкостей.
- Город: разные HTML по актам, здания — магазин, таверна, караван, гильдия, тренировочный зал.
- Гильдии: создание за 1000 золота; вкладки инфо/состав/банк/чат/управление. Лимиты на снятие из банка задаёт глава (тип лимита уточнить).

## Бой, сообщения и анти-спам
- Урон от сообщений: `урон = base_skill_damage * media_coef * (1 + бонусы статов)`.
- Коэффициенты медиа (из первой версии): текст 1.0, стикер 0.9, фото 1.2, GIF 1.5, аудио 2.0, видео 1.8, голос 2.5, ссылка 1.3.
- Анти-спам: не более 3 сообщений за 3 секунды на игрока в бою, избыточные игнорируются.
- Таймеры подземелий исключены.

## Энергия и навыки
- Энергия: кап 100, реген 5/мин вне боя. В бою опционально малая реген 1–2 за тик (уточнить перед реализацией).
- Активные навыки: тратят энергию 5–15, кулдаун 5–20 с (по силе навыка). При недостатке энергии действие недоступно.
- Пассивные навыки: без затрат энергии, кэп прокачки зависит от акта (1–5 акт: 3/6/9/12/15).

## Формулы (предложенные, можно балансить)
- HP: `base_hp(level) + ВЫН * k_hp`, где `k_hp ≈ 8–12`, `base_hp` растёт с уровнем линейно.
- Базовый урон: `weapon_damage * (1 + СИЛ*melee_coef / ЛОВ*ranged_coef / ИНТ*spell_coef по типу атаки)`.
- Крит: шанс = `ЛОВ*0.4% + УДЧ*0.2%`, множитель 1.5–2.0x (кэп по шансам по согласованию).
- Уклон: шанс = `ЛОВ*0.2% + УДЧ*0.1%`, с кэпаом.
- Энергозатраты см. выше.

## Дроп, предметы, tier
- 10 tier предметов (каждые 5 уровней). Common может быть уровнем выше Rare из нижнего tier.
- Аффиксы по редкости: C/U/R/E/L = 0/1/2/3/4 аффикса. Значения скейлятся от tier.

### Диапазоны уровней предметов по актам/редкостям (пример)
- Акт 1 (данжи 1–10, tier 1–2):
  - Common: lvl 3–12 (может быть выше Rare t1)
  - Uncommon: lvl 2–10
  - Rare: lvl 1–8
- Акт 2 (11–20, tier 3–4):
  - Common: lvl 13–22
  - Uncommon: lvl 12–20
  - Rare: lvl 11–18
  - Epic (редко): lvl 11–16
- Акт 3 (21–30, tier 5–6):
  - Common: lvl 23–32
  - Uncommon: lvl 22–30
  - Rare: lvl 21–28
  - Epic (редко): lvl 21–26
- Акт 4 (31–40, tier 7–8):
  - Common: lvl 33–42
  - Uncommon: lvl 32–40
  - Rare: lvl 31–38
  - Epic: lvl 31–36
  - Legendary (очень редко): lvl 31–34
- Акт 5 (41–50, tier 9–10):
  - Common: lvl 43–52
  - Uncommon: lvl 42–50
  - Rare: lvl 41–48
  - Epic: lvl 41–46
  - Legendary: lvl 41–44

### Шансы редкостей по актам (пример, подлежит балансу)
- Акт1: C 80%, U 18%, R 2%
- Акт2: C 70%, U 22%, R 7%, E 1%
- Акт3: C 60%, U 25%, R 12%, E 3%
- Акт4: C 50%, U 28%, R 15%, E 6%, L 1%
- Акт5: C 40%, U 30%, R 18%, E 10%, L 2%

## Магазин и gamble
- Ассортимент 3×3, редкость ≤ Rare, шансы зависят от акта (см. шансы выше, но без Legendary; Epic редка).
- Уровень предметов магазина по акту: 1–10, 11–20, 21–30, 31–40, 41–50 (по актам 1–5).
- Gamble: предмет от Uncommon до Epic, цена = `min(10000, base + level * X)` (X и base зафиксировать при реализации). Шансы (предложение): U 60%, R 30%, E 10% (без L).

## Гильдии
- Создание: 1000 золота, main_Waifu ≥ 1 уровня.
- Ограничения на вступление: уровень/раса/класс по выбору главы.
- Банк: лимит снятия задаётся главой (формат лимита уточнить: абсолют/день/процент).
- Чат гильдии, список участников с онлайн-детектом: активность в течение 5 мин = онлайн.

## Подземелья и экспедиции
- Типы: одиночные, экспедиции, групповые.
- Каждое текстовое сообщение в бою наносит урон по формуле (см. бой).
- Финальный босс на акт; переход в следующий акт после победы.
- Награды: золото/опыт/дроп завязаны на акт, уровень данжа и tier (точные числа при балансировке).

## Таверна, отряд
- 4 слота найма в день, стоимость 10000 золота. Обновление — 1/день, кнопка админа может форс-обновить.
- Отряд: 6 слотов + резерв (точный размер резерва утвердить: 10–20). Замена вайфу: перенос в резерв/из резерва, модалки выбора.

## Тестирование и мониторинг
- Юнит-тесты боевых/экономических формул, интеграции API, нагрузочные на бой/SSE.
- Логи + метрики; алерты по ошибкам вебхука/падению SSE/ошибкам БД.

## Требующие ручного вмешательства/уточнения
- Точные коэффициенты (k_hp, melee/ranged/spell coef, base_skill_damage, X/base для gamble).
- Ширина/формат лимитов банка гильдии.
- Размер резерва наёмных.
- Решение по регену энергии в бою (включить/нет, скорость).
- Шансы/значения аффиксов по tier и по редкости (таблицы).
- Настройка CI/CD, бэкапов и секретов (бот-токен, webhook секрет, ключи SSH).


